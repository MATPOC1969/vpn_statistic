# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –¥–ª—è VPN Statistics

## –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–æ–µ –ø–æ–ª–µ `public_key_client` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ **–∫–ª–∏–µ–Ω—Ç–∞** (–≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ –∏–∑ `PrivateKey`).

### –î–≤–∞ —Ç–∏–ø–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π:
- **`public_key`** ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á **—Å–µ—Ä–≤–µ—Ä–∞** (–∏–∑ `[Peer]` –≤ –∫–æ–Ω—Ñ–∏–≥–µ –∫–ª–∏–µ–Ω—Ç–∞) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤
- **`public_key_client`** ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á **–∫–ª–∏–µ–Ω—Ç–∞** (–≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π –∏–∑ `PrivateKey` –≤ `[Interface]`) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏–∑ `wg show dump`

## –®–∞–≥–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

### 1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏—é

```bash
sudo -u postgres psql -d services -f migration_add_public_key_client.sql
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:

```sql
ALTER TABLE vpnusers 
ADD COLUMN IF NOT EXISTS public_key_client TEXT;

COMMENT ON COLUMN vpnusers.public_key IS '–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –°–ï–†–í–ï–†–ê (–∏–∑ [Peer] –≤ –∫–æ–Ω—Ñ–∏–≥–µ –∫–ª–∏–µ–Ω—Ç–∞)';
COMMENT ON COLUMN vpnusers.public_key_client IS '–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –ö–õ–ò–ï–ù–¢–ê (–≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π –∏–∑ PrivateKey)';

CREATE INDEX IF NOT EXISTS idx_vpnusers_address_provider_interface 
ON vpnusers(address, provider1, interface) 
WHERE public_key_client IS NOT NULL;
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –ù–∞–π–¥—ë—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –±–µ–∑ `public_key_client`
- –í—ã—á–∏—Å–ª–∏—Ç –ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ –∏—Ö –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π
- –ó–∞—à–∏—Ñ—Ä—É–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∏—Ö –≤ –ë–î

```bash
sudo python3 /opt/backups/scripts/vpn_statistic.py
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–í –ª–æ–≥–µ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å—Ç—Ä–æ–∫–∏:
```
üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è N —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π...
    üîë –û–±–Ω–æ–≤–ª–µ–Ω public_key_client –¥–ª—è –ö–û–î_–ö–õ–ò–ï–ù–¢–ê
```

–ò –∑–∞—Ç–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:
```
‚úÖ –ö–û–î_–ö–õ–ò–ï–ù–¢–ê (IP_–ê–î–†–ï–°) ‚Äî üü¢ –∞–∫—Ç–∏–≤–µ–Ω, RX: ..., TX: ...
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ N –∑–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ VPN
```

## –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

### –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
1. –ë—Ä–∞–ª–∏ `PublicKey` –∏–∑ —Å–µ–∫—Ü–∏–∏ `[Peer]` –∫–æ–Ω—Ñ–∏–≥–∞ –∫–ª–∏–µ–Ω—Ç–∞ (—ç—Ç–æ –∫–ª—é—á —Å–µ—Ä–≤–µ—Ä–∞!)
2. –ü—ã—Ç–∞–ª–∏—Å—å —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å `wg show dump` (—Ç–∞–º –∫–ª—é—á–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤)
3. ‚ùå –°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –±—ã–ª–æ

### –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
1. –ë–µ—Ä—ë–º IP –∏–∑ `allowed_ips` –≤ `wg show dump`
2. –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å —Ç–∞–∫–∏–º IP –Ω–∞ –¥–∞–Ω–Ω–æ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ/–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º `public_key_client`
4. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø—É–±–ª–∏—á–Ω—ã–º –∫–ª—é—á–æ–º –∏–∑ `wg show dump`
5. ‚úÖ –ü—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

## –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

```sql
ALTER TABLE vpnusers DROP COLUMN IF EXISTS public_key_client;
DROP INDEX IF EXISTS idx_vpnusers_address_provider_interface;
```

**–í–Ω–∏–º–∞–Ω–∏–µ!** –ü–æ—Å–ª–µ –æ—Ç–∫–∞—Ç–∞ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

